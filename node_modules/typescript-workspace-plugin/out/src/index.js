"use strict";
const fs = require("fs");
const path = require("path");
// Settings for the plugin section in tsconfig.json
/*
interface Settings {

}
*/
function init(_modules) {
    //const _ts = modules.typescript;
    function create(info) {
        let patchedOptions = false;
        let log = (content) => {
            info.project.projectService.logger.info('typescript-workspace-plugin-log ' + content);
        };
        log('---- WORKING ----');
        log('loaded for ' + info.project.getProjectName());
        let rootPath = path.dirname(info.project.getProjectName());
        let rootPkgJson = null;
        do {
            let jsonFile = path.join(rootPath, 'package.json');
            log('Trying ' + jsonFile);
            if (fs.existsSync(jsonFile)) {
                rootPkgJson = JSON.parse(fs.readFileSync(jsonFile, 'utf8'));
                let sources = rootPkgJson['workspace-sources'];
                if (sources) {
                    log('Found workspace: ' + JSON.stringify(sources));
                    let pathOptions = {
                        baseUrl: rootPath,
                        paths: {},
                        rootDir: undefined
                    };
                    for (let key of Object.keys(sources)) {
                        if (!pathOptions.paths[key])
                            pathOptions.paths[key] = [];
                        for (let srcPath of sources[key]) {
                            let resolvedPath = path.resolve(rootPath, srcPath);
                            if (pathOptions.paths[key].indexOf(resolvedPath) < 0) {
                                pathOptions.paths[key].unshift(resolvedPath);
                            }
                        }
                    }
                    let oldCOptions = info.project.getCompilerOptions;
                    info.project.getCompilerOptions = function () {
                        let oldOptions = oldCOptions.call(this);
                        if (!patchedOptions) {
                            log('Got old options:' + JSON.stringify(oldOptions));
                            oldOptions = Object.assign(oldOptions, pathOptions);
                            info.project.setCompilerOptions(oldOptions);
                            log('Got new options:' + JSON.stringify(oldOptions));
                            patchedOptions = true;
                        }
                        return oldOptions;
                    };
                    let replacer = (s) => s;
                    let remainingGood = (_s) => true;
                    Object.keys(sources).forEach(p => {
                        let pathVal = sources[p];
                        let replacement = '"' + p.replace('*', '$1') + '"';
                        let searchment = new RegExp('[\'"]' + pathVal[0].replace('*', '(.+)') + '[\'"]');
                        let modulePattern = new RegExp(pathVal[0].replace('*', '(.+)') + '/');
                        let oldReplacer = replacer;
                        let oldTester = remainingGood;
                        replacer = (fileImport) => {
                            let res = oldReplacer(fileImport);
                            let next = res.replace(searchment, replacement);
                            //log(`${res} -> ${next} ;; via ${searchment} -> ${replacement}`);
                            return next;
                        };
                        remainingGood = s => {
                            let old = oldTester(s) && !modulePattern.test(s);
                            return old;
                        };
                    });
                    let cfap = info.languageService.getCodeFixesAtPosition;
                    info.languageService.getCodeFixesAtPosition = function (_fileName) {
                        let results = cfap.apply(this, arguments);
                        results.forEach(res => {
                            if (!res.description.match(/import.+from module/i))
                                return res;
                            res.description = replacer(res.description);
                            res.changes.forEach(c => {
                                c.textChanges.forEach(t => {
                                    t.newText = replacer(t.newText);
                                });
                            });
                        });
                        return results.filter(res => remainingGood(res.description));
                    };
                    break;
                }
                rootPkgJson = null;
            }
            else {
                log('File does not exist: ' + jsonFile);
            }
            let newRoot = path.resolve(rootPath, '..');
            if (newRoot == rootPath)
                break;
            rootPath = newRoot;
        } while (true);
        return info.languageService;
    }
    return { create };
}
module.exports = init;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFFN0IsbURBQW1EO0FBRW5EOzs7O0VBSUU7QUFFRixTQUFTLElBQUksQ0FBQyxRQUEwQztJQUN0RCxpQ0FBaUM7SUFFakMsU0FBUyxNQUFNLENBQUMsSUFBZ0M7UUFDOUMsSUFBSSxjQUFjLEdBQUcsS0FBSyxDQUFDO1FBQzNCLElBQUksR0FBRyxHQUFHLENBQUMsT0FBWSxFQUFFLEVBQUU7WUFDekIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxrQ0FBa0MsR0FBRyxPQUFPLENBQUMsQ0FBQztRQUN4RixDQUFDLENBQUM7UUFFRixHQUFHLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUV6QixHQUFHLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQztRQUVuRCxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQztRQUUzRCxJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDdkIsR0FBRztZQUNELElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1lBQ25ELEdBQUcsQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDLENBQUM7WUFDMUIsSUFBSSxFQUFFLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUMzQixXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUM1RCxJQUFJLE9BQU8sR0FBRyxXQUFXLENBQUMsbUJBQW1CLENBQUMsQ0FB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Q0wsQ0FBQyxDQUFDLENBQUM7d0JBQ0gsT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO29CQUMvRCxDQUFDLENBQUM7b0JBRUYsTUFBTTtpQkFDUDtnQkFDRCxXQUFXLEdBQUcsSUFBSSxDQUFDO2FBQ3BCO2lCQUFNO2dCQUNMLEdBQUcsQ0FBQyx1QkFBdUIsR0FBRyxRQUFRLENBQUMsQ0FBQzthQUN6QztZQUVELElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQzNDLElBQUksT0FBTyxJQUFJLFFBQVE7Z0JBQUUsTUFBTTtZQUMvQixRQUFRLEdBQUcsT0FBTyxDQUFDO1NBQ3BCLFFBQVEsSUFBSSxFQUFFO1FBRWYsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDO0lBQzlCLENBQUM7SUFFRCxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUM7QUFDcEIsQ0FBQztBQUVELGlCQUFTLElBQUksQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHRzX21vZHVsZSBmcm9tICd0eXBlc2NyaXB0L2xpYi90c3NlcnZlcmxpYnJhcnknO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcblxuLy8gU2V0dGluZ3MgZm9yIHRoZSBwbHVnaW4gc2VjdGlvbiBpbiB0c2NvbmZpZy5qc29uXG5cbi8qXG5pbnRlcmZhY2UgU2V0dGluZ3Mge1xuXG59XG4qL1xuXG5mdW5jdGlvbiBpbml0KF9tb2R1bGVzOiB7IHR5cGVzY3JpcHQ6IHR5cGVvZiB0c19tb2R1bGUgfSkge1xuICAvL2NvbnN0IF90cyA9IG1vZHVsZXMudHlwZXNjcmlwdDtcblxuICBmdW5jdGlvbiBjcmVhdGUoaW5mbzogdHMuc2VydmVyLlBsdWdpbkNyZWF0ZUluZm8pIHtcbiAgICBsZXQgcGF0Y2hlZE9wdGlvbnMgPSBmYWxzZTtcbiAgICBsZXQgbG9nID0gKGNvbnRlbnQ6IGFueSkgPT4ge1xuICAgICAgaW5mby5wcm9qZWN0LnByb2plY3RTZXJ2aWNlLmxvZ2dlci5pbmZvKCd0eXBlc2NyaXB0LXdvcmtzcGFjZS1wbHVnaW4tbG9nICcgKyBjb250ZW50KTtcbiAgICB9O1xuXG4gICAgbG9nKCctLS0tIFdPUktJTkcgLS0tLScpO1xuXG4gICAgbG9nKCdsb2FkZWQgZm9yICcgKyBpbmZvLnByb2plY3QuZ2V0UHJvamVjdE5hbWUoKSk7XG5cbiAgICBsZXQgcm9vdFBhdGggPSBwYXRoLmRpcm5hbWUoaW5mby5wcm9qZWN0LmdldFByb2plY3ROYW1lKCkpO1xuXG4gICAgbGV0IHJvb3RQa2dKc29uID0gbnVsbDtcbiAgICBkbyB7XG4gICAgICBsZXQganNvbkZpbGUgPSBwYXRoLmpvaW4ocm9vdFBhdGgsICdwYWNrYWdlLmpzb24nKTtcbiAgICAgIGxvZygnVHJ5aW5nICcgKyBqc29uRmlsZSk7XG4gICAgICBpZiAoZnMuZXhpc3RzU3luYyhqc29uRmlsZSkpIHtcbiAgICAgICAgcm9vdFBrZ0pzb24gPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhqc29uRmlsZSwgJ3V0ZjgnKSk7XG4gICAgICAgIGxldCBzb3VyY2VzID0gcm9vdFBrZ0pzb25bJ3dvcmtzcGFjZS1zb3VyY2VzJ107XG4gICAgICAgIGlmIChzb3VyY2VzKSB7XG4gICAgICAgICAgbG9nKCdGb3VuZCB3b3Jrc3BhY2U6ICcgKyBKU09OLnN0cmluZ2lmeShzb3VyY2VzKSk7XG4gICAgICAgICAgbGV0IHBhdGhPcHRpb25zID0gKHtcbiAgICAgICAgICAgICBiYXNlVXJsOiByb290UGF0aCxcbiAgICAgICAgICAgICBwYXRoczoge30sXG4gICAgICAgICAgICAgcm9vdERpcjogdW5kZWZpbmVkXG4gICAgICAgICAgICB9IGFzIGFueSkgYXMgdHNfbW9kdWxlLkNvbXBpbGVyT3B0aW9ucztcblxuICAgICAgICAgIGZvciAobGV0IGtleSBvZiBPYmplY3Qua2V5cyhzb3VyY2VzKSkge1xuICAgICAgICAgICAgaWYgKCFwYXRoT3B0aW9ucy5wYXRoc1trZXldKSBwYXRoT3B0aW9ucy5wYXRoc1trZXldID0gW107XG4gICAgICAgICAgICBmb3IgKGxldCBzcmNQYXRoIG9mIHNvdXJjZXNba2V5XSkge1xuICAgICAgICAgICAgICBsZXQgcmVzb2x2ZWRQYXRoID0gcGF0aC5yZXNvbHZlKHJvb3RQYXRoLCBzcmNQYXRoKTtcbiAgICAgICAgICAgICAgaWYgKHBhdGhPcHRpb25zLnBhdGhzW2tleV0uaW5kZXhPZihyZXNvbHZlZFBhdGgpIDwgMCkge1xuICAgICAgICAgICAgICAgIHBhdGhPcHRpb25zLnBhdGhzW2tleV0udW5zaGlmdChyZXNvbHZlZFBhdGgpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgbGV0IG9sZENPcHRpb25zID0gaW5mby5wcm9qZWN0LmdldENvbXBpbGVyT3B0aW9ucztcblxuICAgICAgICAgIGluZm8ucHJvamVjdC5nZXRDb21waWxlck9wdGlvbnMgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIGxldCBvbGRPcHRpb25zID0gb2xkQ09wdGlvbnMuY2FsbCh0aGlzKTtcbiAgICAgICAgICAgIGlmICghcGF0Y2hlZE9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgbG9nKCdHb3Qgb2xkIG9wdGlvbnM6JyArIEpTT04uc3RyaW5naWZ5KG9sZE9wdGlvbnMpKTtcbiAgICAgICAgICAgICAgb2xkT3B0aW9ucyA9IE9iamVjdC5hc3NpZ24ob2xkT3B0aW9ucywgcGF0aE9wdGlvbnMpO1xuICAgICAgICAgICAgICBpbmZvLnByb2plY3Quc2V0Q29tcGlsZXJPcHRpb25zKG9sZE9wdGlvbnMpO1xuICAgICAgICAgICAgICBsb2coJ0dvdCBuZXcgb3B0aW9uczonICsgSlNPTi5zdHJpbmdpZnkob2xkT3B0aW9ucykpO1xuICAgICAgICAgICAgICBwYXRjaGVkT3B0aW9ucyA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gb2xkT3B0aW9ucztcbiAgICAgICAgICB9O1xuXG4gICAgICAgICAgbGV0IHJlcGxhY2VyID0gKHM6IHN0cmluZykgPT4gcztcbiAgICAgICAgICBsZXQgcmVtYWluaW5nR29vZCA9IChfczogc3RyaW5nKSA9PiB0cnVlO1xuICAgICAgICAgIE9iamVjdC5rZXlzKHNvdXJjZXMpLmZvckVhY2gocCA9PiB7XG4gICAgICAgICAgICBsZXQgcGF0aFZhbCA9IHNvdXJjZXNbcF07XG4gICAgICAgICAgICBsZXQgcmVwbGFjZW1lbnQgPSAnXCInICsgcC5yZXBsYWNlKCcqJywgJyQxJykgKyAnXCInO1xuICAgICAgICAgICAgbGV0IHNlYXJjaG1lbnQgPSBuZXcgUmVnRXhwKCdbXFwnXCJdJyArIHBhdGhWYWxbMF0ucmVwbGFjZSgnKicsICcoLispJykgKyAnW1xcJ1wiXScpO1xuICAgICAgICAgICAgbGV0IG1vZHVsZVBhdHRlcm4gPSBuZXcgUmVnRXhwKHBhdGhWYWxbMF0ucmVwbGFjZSgnKicsICcoLispJykgKyAnLycpO1xuICAgICAgICAgICAgbGV0IG9sZFJlcGxhY2VyID0gcmVwbGFjZXI7XG4gICAgICAgICAgICBsZXQgb2xkVGVzdGVyID0gcmVtYWluaW5nR29vZDtcbiAgICAgICAgICAgIHJlcGxhY2VyID0gKGZpbGVJbXBvcnQpID0+IHtcbiAgICAgICAgICAgICAgbGV0IHJlcyA9IG9sZFJlcGxhY2VyKGZpbGVJbXBvcnQpO1xuICAgICAgICAgICAgICBsZXQgbmV4dCA9IHJlcy5yZXBsYWNlKHNlYXJjaG1lbnQsIHJlcGxhY2VtZW50KTtcbiAgICAgICAgICAgICAgLy9sb2coYCR7cmVzfSAtPiAke25leHR9IDs7IHZpYSAke3NlYXJjaG1lbnR9IC0+ICR7cmVwbGFjZW1lbnR9YCk7XG4gICAgICAgICAgICAgIHJldHVybiBuZXh0O1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHJlbWFpbmluZ0dvb2QgPSBzID0+IHtcbiAgICAgICAgICAgICAgbGV0IG9sZCA9IG9sZFRlc3RlcihzKSAmJiAhbW9kdWxlUGF0dGVybi50ZXN0KHMpO1xuICAgICAgICAgICAgICByZXR1cm4gb2xkO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIGxldCBjZmFwID0gaW5mby5sYW5ndWFnZVNlcnZpY2UuZ2V0Q29kZUZpeGVzQXRQb3NpdGlvbjtcblxuICAgICAgICAgIGluZm8ubGFuZ3VhZ2VTZXJ2aWNlLmdldENvZGVGaXhlc0F0UG9zaXRpb24gPSBmdW5jdGlvbihcbiAgICAgICAgICAgIF9maWxlTmFtZTogc3RyaW5nXG4gICAgICAgICAgKTogUmVhZG9ubHlBcnJheTx0cy5Db2RlRml4QWN0aW9uPiB7XG4gICAgICAgICAgICBsZXQgcmVzdWx0cyA9IGNmYXAuYXBwbHkodGhpcywgYXJndW1lbnRzKSBhcyBSZWFkb25seUFycmF5PHRzLkNvZGVGaXhBY3Rpb24+O1xuICAgICAgICAgICAgcmVzdWx0cy5mb3JFYWNoKHJlcyA9PiB7XG4gICAgICAgICAgICAgIGlmICghcmVzLmRlc2NyaXB0aW9uLm1hdGNoKC9pbXBvcnQuK2Zyb20gbW9kdWxlL2kpKSByZXR1cm4gcmVzO1xuICAgICAgICAgICAgICByZXMuZGVzY3JpcHRpb24gPSByZXBsYWNlcihyZXMuZGVzY3JpcHRpb24pO1xuICAgICAgICAgICAgICByZXMuY2hhbmdlcy5mb3JFYWNoKGMgPT4ge1xuICAgICAgICAgICAgICAgIGMudGV4dENoYW5nZXMuZm9yRWFjaCh0ID0+IHtcbiAgICAgICAgICAgICAgICAgIHQubmV3VGV4dCA9IHJlcGxhY2VyKHQubmV3VGV4dCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0cy5maWx0ZXIocmVzID0+IHJlbWFpbmluZ0dvb2QocmVzLmRlc2NyaXB0aW9uKSk7XG4gICAgICAgICAgfTtcblxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIHJvb3RQa2dKc29uID0gbnVsbDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZygnRmlsZSBkb2VzIG5vdCBleGlzdDogJyArIGpzb25GaWxlKTtcbiAgICAgIH1cblxuICAgICAgbGV0IG5ld1Jvb3QgPSBwYXRoLnJlc29sdmUocm9vdFBhdGgsICcuLicpO1xuICAgICAgaWYgKG5ld1Jvb3QgPT0gcm9vdFBhdGgpIGJyZWFrO1xuICAgICAgcm9vdFBhdGggPSBuZXdSb290O1xuICAgIH0gd2hpbGUgKHRydWUpO1xuXG4gICAgcmV0dXJuIGluZm8ubGFuZ3VhZ2VTZXJ2aWNlO1xuICB9XG5cbiAgcmV0dXJuIHsgY3JlYXRlIH07XG59XG5cbmV4cG9ydCA9IGluaXQ7XG4iXX0=